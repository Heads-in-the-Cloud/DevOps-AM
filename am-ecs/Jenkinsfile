pipeline {
    agent {
        node {
            label 'aws-ready'
            customWorkspace "${AM_DEVOPS_DIRECTORY}/environments/${AM_DEPLOY_ENVIRONMENT}"
        }
    }

    environment {
        COMMIT_HASH     = sh(returnStdout: true, script: "git rev-parse --short=8 HEAD").trim()

        // AWS Region Override
        AWS_PROFILE     = "am_aws"
        DEPLOY_MODE     = "${AM_DEPLOY_ENVIRONMENT}"
        OUTPUT_DIR      = "${WORKSPACE}"

        // Secrets Manager
        SECRET_BASE     = credentials("AM_SECRET_ID_BASE")
        SECRET_ID       = "${DEPLOY_MODE}/${SECRET_BASE}"

        ECS_MEM_LIMIT   = "1024M"
        ECS_MEM_REQUEST = "256M"
        ECS_CPU_LIMIT   = "1.0"
        ECS_CPU_REQUEST = "0.5"
        ECS_REPLICAS    = "2"

        DB_POOL_MIN     = 2
        DB_POOL_MAX     = 4

        // Repo Information
        CUR_REPO_TYPE   = "${AM_CURRENT_REPO_TYPE}"
        ART_REPO_NAME   = credentials("AM_ARTIFACTORY_ENDPOINT")

        // Repositories
        ECR_REPO_LOC    = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION_ID}.amazonaws.com"
        ART_REPO_LOC    = "${ART_REPO_NAME}/am-utopia"
        CUR_REPO_LOC    = getRepoLoc(CUR_REPO_TYPE, ECR_REPO_LOC, ART_REPO_LOC)
    }

    stages {
        stage('Setup Working Directory') {
            steps {
                sh "mkdir -p ${ECS_DIR}"
                sh "cp am-ecs/docker-compose-template.yml ${ECS_DIR}"
            }
        }

        stage('Load Environment') {
            steps {
                sh 'aws configure set region ${AWS_REGION_ID} --profile ${AWS_PROFILE_NAME}'
                script {
                    // Get env from Secrets
                    secret = sh(returnStdout: true, script: 'aws secretsmanager get-secret-value --secret-id ${SECRET_ID} | jq -Mr \'.SecretString\'').trim()
                    def jsonObj = readJSON text: secret
                    env.AWS_RDS_USERNAME    = jsonObj.DB_USERNAME
                    env.AWS_RDS_PASSWORD    = jsonObj.DB_PASSWORD
                    env.AWS_VPC_ID          = jsonObj.AWS_VPC_ID
                    env.AWS_RDS_ENDPOINT    = jsonObj.AWS_RDS_ENDPOINT
                    env.AWS_ALB_ID          = jsonObj.AWS_ALB_ID
                    env.AWS_ECS_SG          = jsonObj.AWS_ECS_SG

                    // Get private subnets via aws-cli
                    def subnets_private = sh(returnStdout: true, script: """
                        aws ec2 describe-subnets --filters Name=vpc-id,Values=${AWS_VPC_ID} \
                        --query 'Subnets[?MapPublicIpOnLaunch==`false`].SubnetId' \
                        | grep subnet | sed 's/[," ]//g'
                    """).readLines()
                    env.PRIVATE_SUBNET_1 = subnets_private[0]
                    env.PRIVATE_SUBNET_2 = subnets_private[1]
                }
            }
        }

        stage('Fill Template') {
            steps {
                echo 'Inserting certain Environment Variables into docker-compose'
                dir("${ECS_DIR}") {
                    sh '''
                        envsubst \' \
                        $ECS_MEM_LIMIT \
                        $ECS_MEM_REQUEST \
                        $ECS_CPU_LIMIT \
                        $ECS_CPU_REQUEST \
                        $ECS_REPLICAS \
                        $AWS_ACCOUNT_ID \
                        $AWS_REGION_ID \
                        $AWS_VPC_ID \
                        $AWS_ALB_ID \
                        $DB_POOL_MIN \
                        $DB_POOL_MAX \
                        $AWS_ECS_SG \
                        $PRIVATE_SUBNET_1 \
                        $PRIVATE_SUBNET_2 \
                        $CUR_REPO_LOC \
                        $DEPLOY_MODE \
                        \' < docker-compose-template.yml > docker-compose.yml
                    '''
                }
            }
        }

        stage('Configure') {
            steps {
                echo 'Configuring ECS'
                sh 'aws configure set region ${AWS_REGION_ID} --profile ${AWS_PROFILE_NAME}'
                sh 'docker context use ${AWS_PROFILE_NAME}'
                sh 'aws ecr get-login-password --region ${AWS_REGION_ID} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION_ID}.amazonaws.com'
            }
        }

        stage('Conversion Log') {
            steps {
                dir("${ECS_DIR}") {
                    sh 'mkdir -p ${AM_DEVOPS_DIRECTORY}/ecs-cloudformation-templates'
                    sh 'docker compose convert > ${AM_DEVOPS_DIRECTORY}/ecs-cloudformation-templates/template-${COMMIT_HASH}.yaml'
                }
            }
        }

        stage('Push ECS') {
            steps {
                echo 'Pushing Up to ECS'
                dir("${ECS_DIR}") {
                    sh 'docker compose up'
                }
            }
        }

        // end stages
    }
}

// Decide which repo to use based on current type; default to ECR
def getRepoLoc(repoType, ecrLoc, artLoc) {
    if(repoType == "ART") {
        return artLoc
    } else {
        return ecrLoc
    }
}
