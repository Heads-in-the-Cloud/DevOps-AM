pipeline {
    agent {label 'aws-ready'}
    environment {
        AWS_RDS_USERNAME = credentials('AM_DB_USERNAME')
        AWS_RDS_PASSWORD = credentials('AM_DB_PASSWORD')
        ECS_CONTEXT_NAME = "am_aws"
        AWS_ACCOUNT_ID = "026390315914"
        AWS_REGION_ID = "us-west-2"
    }
    stages {
        stage('Load Environment') {
            steps {
                echo 'Loading Environment'
                script {
                    def outputs = readProperties file: '/var/lib/jenkins-worker-node/AM-resources/env.tf'
                    env.AWS_VPC_ID = outputs.AWS_VPC_ID
                    env.AWS_RDS_ENDPOINT = outputs.AWS_RDS_ENDPOINT
                    env.AWS_ALB_ID = outputs.AWS_ALB_ID
                }
                sh 'echo Environment loaded: VPC = ${AWS_VPC_ID} ----- RDS = ${AWS_RDS_ENDPOINT}'
            }
        }
        stage('Push ECS') {
            steps {
                echo 'Configuring ECS'
                dir("am-ecs") {
                    sh 'docker context use ${ECS_CONTEXT_NAME}'
                    sh 'aws ecr get-login-password --region ${AWS_REGION_ID} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION_ID}.amazonaws.com'
                    sh 'docker compose up --no-color'
                }
            }
        }
    }
}
